<div class="admin-container">
  <!-- Menu Lateral -->
  <aside class="sidebar">
    <h2>Feita de Bronze</h2>
    <nav>
      <ul>
          
          <li *ngFor="let item of menuItems">
           <!-- <a [routerLink]="item.route" routerLinkActive="active">{{ item.label }}</a>-->

          <a href="javascript:void(0)" (click)="selecionarVista(item.view)" [class.active]="currentView === item.view">
            {{ item.label }}
          </a>
        </li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" (click)="logout()">Sair</button>
    </div> 
  </aside>


  <!-- ConteÃºdo Principal -->
  <main class="main-content">
    <header>
      <h1>Painel Administrativo - {{ currentView | titlecase }}</h1>
    </header>

    <!-- VisÃ£o Financeira -->
    <section *ngIf="currentView === 'financeiro'">
      <div class="section-header">
        <h3>Painel Financeiro</h3>
      </div>
      
      <div class="finance-cards">
        <div class="card entrada">
          <h4>Entradas (Comandas)</h4>
          <p>R$ {{ totalEntradas | number:'1.2-2' }}</p>
        </div>
        <div class="card saida-contas">
          <h4>SaÃ­das (Contas)</h4>
          <p>R$ {{ totalContas | number:'1.2-2' }}</p>
        </div>
        <div class="card saida-compras">
          <h4>SaÃ­das (Compras)</h4>
          <p>R$ {{ totalCompras | number:'1.2-2' }}</p>
        </div>
        <div class="card saldo" [class.negativo]="saldo < 0">
          <h4>Saldo</h4>
          <p>R$ {{ saldo | number:'1.2-2' }}</p>
        </div>
      </div>

      <div class="chart-container">
        <h4>VisÃ£o Geral Financeira</h4>
        <div class="simple-bar-chart">
          <div class="bar-group">
            <div class="bar entrada-bar" [style.height.%]="(totalEntradas / (totalEntradas + totalSaidas || 1)) * 100" [title]="'Entradas: R$ ' + totalEntradas"></div>
            <span class="label">Entradas</span>
          </div>
          <div class="bar-group">
            <div class="bar saida-contas-bar" [style.height.%]="(totalContas / (totalEntradas + totalSaidas || 1)) * 100" [title]="'Contas: R$ ' + totalContas"></div>
            <span class="label">Contas</span>
          </div>
          <div class="bar-group">
            <div class="bar saida-compras-bar" [style.height.%]="(totalCompras / (totalEntradas + totalSaidas || 1)) * 100" [title]="'Compras: R$ ' + totalCompras"></div>
            <span class="label">Compras</span>
          </div>
        </div>
      </div>
    </section>

    <!-- VisÃ£o de Comandas -->
    <section *ngIf="currentView === 'comandas'">
      <div class="section-header">
        <h3>Comandas LanÃ§adas</h3>
        <button class="btn-primary" (click)="abrirFormulario('Comanda')">+ LanÃ§ar Comanda</button>
      </div>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>Cliente</th><th>Data</th><th>Total</th><th>Status</th><th>Pagamento</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            <tr *ngFor="let c of comandas">
              <td>{{ c.id }}</td>
              <td>{{ c.clienteNome }}</td>
              <td>{{ c.data | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>R$ {{ c.valorTotal | number:'1.2-2' }}</td>
              <td>
                <span class="status-badge" [ngClass]="c.fechada ? 'aprovado' : 'pendente'">
                  {{ c.fechada ? 'FECHADA' : 'ABERTA' }}
                </span>
              </td>
              <td>{{ c.formaPagamento || '-' }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('Comanda', c)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('Comanda', c.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VisÃ£o de Agendamentos -->
    <!-- VisÃ£o de Clientes -->
    <section *ngIf="currentView === 'clientes'">
      <h3>Cadastro de Clientes</h3>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>Nome</th><th>Email</th><th>Telefone</th><th>AÃ§Ãµes</th></tr></thead>
           <tbody>
            <tr *ngFor="let cliente of clientes">
              <td>{{ cliente.id }}</td>
              <td>{{ cliente.nome }}</td>
               <td>{{ cliente.email }}</td>
              <td>{{ cliente.telefone }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('Cliente', cliente)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('Cliente', cliente.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="section-header">

        <button class="btn-primary" (click)="abrirFormulario('Cliente')">+ Novo Cliente</button>
      </div>
    </section>

    <!-- VisÃ£o de Agendamentos -->

    <section class="appointments-section" *ngIf="currentView === 'agendamentos'">
      <div class="section-header">
        <h3>VisÃ£o Geral de Agendamentos</h3>
        <button class="btn-primary" (click)="abrirFormulario('Agendamento')">+ Novo Agendamento</button>
      </div>
      
      <div class="table-responsive">
        <table class="appointments-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Procedimento</th>
              <th>Data/Hora</th>
              <th>Status</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="agendamentos.length === 0">
              <td colspan="5" style="text-align: center;">Nenhum agendamento encontrado.</td>
            </tr>
            <tr *ngFor="let item of agendamentos">
              <td><strong>{{ item.nomeCliente }}</strong><br><small>{{ item.telefone }}</small></td>
              <td>{{ item.procedimento }}</td>
              <td>{{ item.dataHora | date:'dd/MM/yyyy HH:mm' }}</td>
              <td><span class="status-badge" [ngClass]="item.status?.toLowerCase() || 'pendente'">{{ item.status || 'PENDENTE' }}</span></td>
              <td>
                <button *ngIf="item.status === 'PENDENTE' || !item.status" class="action-btn approve" (click)="aprovar(item)" title="Aprovar">âœ”</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VisÃ£o de Unidades -->
    <section *ngIf="currentView === 'unidades'">
      <div class="section-header">
        <h3>Cadastro de Unidades</h3>
        <button class="btn-primary" (click)="abrirFormulario('Unidade')">+ Nova Unidade</button>
      </div>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>Nome</th><th>EndereÃ§o</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            <tr *ngFor="let u of unidades">
              <td>{{ u.id }}</td><td>{{ u.nome }}</td><td>{{ u.endereco }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('Unidade', u)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('Unidade', u.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VisÃ£o de UsuÃ¡rios -->
    <section *ngIf="currentView === 'usuarios'">
      <div class="section-header">
        <h3>Cadastro de UsuÃ¡rios</h3>
        <button class="btn-primary" (click)="abrirFormulario('UsuÃ¡rio')">+ Novo UsuÃ¡rio</button>
      </div>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>Nome</th><th>Email</th><th>Role</th><th>Unidade</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            <tr *ngFor="let u of usuarios">
              <td>{{ u.id }}</td><td>{{ u.nome }}</td><td>{{ u.email }}</td><td>{{ u.role }}</td><td>{{ u.unidadeId }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('UsuÃ¡rio', u)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('UsuÃ¡rio', u.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VisÃ£o de Produtos -->
    <section *ngIf="currentView === 'produtos'">
      <div class="section-header">
        <h3>Cadastro de Produtos</h3>
        <button class="btn-primary" (click)="abrirFormulario('Produto')">+ Novo Produto</button>
      </div>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>Nome</th><th>PreÃ§o</th><th>Estoque</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            <tr *ngFor="let p of produtos">
              <td>{{ p.id }}</td><td>{{ p.nome }}</td><td>R$ {{ p.preco }}</td><td>{{ p.quantidadeEstoque }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('Produto', p)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('Produto', p.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VisÃ£o de Procedimentos -->
    <section *ngIf="currentView === 'procedimentos'">
      <div class="section-header">
        <h3>Cadastro de Procedimentos</h3>
        <button class="btn-primary" (click)="abrirFormulario('Procedimento')">+ Novo Procedimento</button>
      </div>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>Nome</th><th>DuraÃ§Ã£o</th><th>Valor</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            <tr *ngFor="let p of procedimentos">
              <td>{{ p.id }}</td><td>{{ p.nome }}</td><td>{{ p.duracao }}</td><td>R$ {{ p.valor }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('Procedimento', p)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('Procedimento', p.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VisÃ£o de Contas -->
    <section *ngIf="currentView === 'contas'">
      <div class="section-header">
        <h3>Contas a Pagar/Receber</h3>
        <button class="btn-primary" (click)="abrirFormulario('Conta')">+ Nova Conta</button>
      </div>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>DescriÃ§Ã£o</th><th>Valor</th><th>Vencimento</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            <tr *ngFor="let c of contas">
              <td>{{ c.id }}</td><td>{{ c.descricao }}</td><td>R$ {{ c.valor }}</td><td>{{ c.dataVencimento }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('Conta', c)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('Conta', c.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- VisÃ£o de Compras -->
    <section *ngIf="currentView === 'compras'">
      <div class="section-header">
        <h3>Registro de Compras</h3>
        <button class="btn-primary" (click)="abrirFormulario('Compra')">+ Nova Compra</button>
      </div>
      <div class="table-responsive">
        <table class="appointments-table">
          <thead><tr><th>ID</th><th>DescriÃ§Ã£o</th><th>Valor</th><th>Data</th><th>Fornecedor</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            <tr *ngFor="let c of compras">
              <td>{{ c.id }}</td><td>{{ c.descricao }}</td><td>R$ {{ c.valor }}</td><td>{{ c.dataCompra | date:'dd/MM/yyyy' }}</td><td>{{ c.fornecedor }}</td>
              <td>
                <button class="action-btn edit" (click)="abrirFormulario('Compra', c)" title="Editar">âœŽ</button>
                <button class="action-btn delete" (click)="excluir('Compra', c.id)" title="Excluir">ðŸ—‘</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Modal de FormulÃ¡rio -->
  <div class="modal-overlay" *ngIf="showModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>{{ formData.id ? 'Editar' : 'Nova' }} {{ formType }}</h2>
        <button class="close-btn" (click)="fecharFormulario()">Ã—</button>
      </div>
      
      <div class="modal-body">
        <form (ngSubmit)="salvarFormulario()">
          
          <!-- Campos para Agendamento -->
          <div *ngIf="formType === 'Agendamento'">
            <div class="form-group">
              <label>Unidade</label>
              <select [(ngModel)]="formData.unidadeId" name="unidadeId" required>
                <option [ngValue]="null" disabled selected>Selecione a unidade</option>
                <option *ngFor="let u of unidades" [value]="u.id">{{ u.nome }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Cliente</label>
              <select [(ngModel)]="formData.nomeCliente" name="nomeCliente" required>
                <option value="" disabled selected>Selecione o cliente</option>
                <option *ngFor="let c of clientes" [value]="c.nome">{{ c.nome }}</option>
              </select>
            </div>
            <div class="form-group"><label>Telefone</label><input [(ngModel)]="formData.telefone" name="telefone" required></div>
            <div class="form-group"><label>Data/Hora</label><input type="datetime-local" [(ngModel)]="formData.dataHora" name="dataHora" required></div>
            <div class="form-group">
              <label>Procedimento</label>
              <select [(ngModel)]="formData.procedimento" name="procedimento" required>
                <option value="" disabled selected>Selecione o procedimento</option>
                <option *ngFor="let p of procedimentos" [value]="p.nome">{{ p.nome }}</option>
              </select>
            </div>
            <div class="form-group"><label>Status</label>
              <select [(ngModel)]="formData.status" name="status" required>
                <option value="PENDENTE">Pendente</option>
                <option value="APROVADO">Aprovado</option>
                <option value="REALIZADO">Realizado</option>
              </select>
            </div>
          </div>

          <!-- Campos para Unidade -->
          <div *ngIf="formType === 'Unidade'">
            <div class="form-group"><label>Nome</label><input [(ngModel)]="formData.nome" name="unidadeNome" required></div>
            <div class="form-group"><label>EndereÃ§o</label><input [(ngModel)]="formData.endereco" name="unidadeEndereco" required></div>
            <div class="form-group"><label>Telefone</label><input [(ngModel)]="formData.telefone" name="unidadeTelefone" required></div>
          </div>
          
          <!-- Campos para Cliente -->
           <div *ngIf="formType === 'Cliente'">
            <div class="form-group"><label>Nome</label><input [(ngModel)]="formData.nome" name="clienteNome" required></div>
            <div class="form-group"><label>Email</label><input type="email" [(ngModel)]="formData.email" name="clienteEmail" required></div>
            <div class="form-group"><label>Telefone</label><input [(ngModel)]="formData.telefone" name="clienteTelefone" required></div>
            <div class="form-group"><label>Apelido</label><input [(ngModel)]="formData.apelido" name="clienteApelido" required></div>
            <div class="form-group"><label>ObservaÃ§Ãµes</label><textarea [(ngModel)]="formData.observacao" name="clienteObservacao"></textarea></div>
          </div>

          <!-- Campos para UsuÃ¡rio -->
          <div *ngIf="formType === 'UsuÃ¡rio'">
            <div class="form-group"><label>Nome</label><input [(ngModel)]="formData.nome" name="usuarioNome" required></div>
            <div class="form-group"><label>Email</label><input type="email" [(ngModel)]="formData.email" name="usuarioEmail" required></div>
            <div class="form-group"><label>Senha</label><input type="password" [(ngModel)]="formData.senha" name="usuarioSenha" required></div>
            <div class="form-group"><label>Role</label>
              <select [(ngModel)]="formData.role" name="usuarioRole" required>
                <option value="ADMIN">Administrador</option>
                <option value="RESPONSAVEL">ResponsÃ¡vel</option>
              </select>
            </div>
            <div class="form-group"><label>Unidade</label>
              <select [(ngModel)]="formData.unidade_id" name="usuarioUnidadeId" required>
                <option *ngFor="let u of unidades" [value]="u.id">{{ u.nome }}</option>
              </select>
            </div>
          </div>

          <!-- Campos para Produto -->
          <div *ngIf="formType === 'Produto'">
            <div class="form-group"><label>Nome</label><input [(ngModel)]="formData.nome" name="produtoNome" required></div>
            <div class="form-group"><label>PreÃ§o</label><input type="number" [(ngModel)]="formData.preco" name="produtoPreco" required></div>
            <div class="form-group"><label>Estoque</label><input type="number" [(ngModel)]="formData.quantidadeEstoque" name="produtoEstoque" required></div>
          </div>

          <!-- Campos para Procedimento -->
          <div *ngIf="formType === 'Procedimento'">
            <div class="form-group"><label>Nome</label><input [(ngModel)]="formData.nome" name="procedimentoNome" required></div>
            <div class="form-group"><label>DuraÃ§Ã£o</label><input [(ngModel)]="formData.duracao" name="procedimentoDuracao" required></div>
            <div class="form-group"><label>Valor</label><input type="number" [(ngModel)]="formData.valor" name="procedimentoValor" required></div>
          </div>

          <!-- Campos para Conta -->
          <div *ngIf="formType === 'Conta'">
            <div class="form-group"><label>DescriÃ§Ã£o</label><input [(ngModel)]="formData.descricao" name="contaDescricao" required></div>
            <div class="form-group"><label>Valor</label><input type="number" [(ngModel)]="formData.valor" name="contaValor" required></div>
            <div class="form-group"><label>Vencimento</label><input type="date" [(ngModel)]="formData.dataVencimento" name="contaVencimento" required></div>
          </div>

          <!-- Campos para Compra -->
          <div *ngIf="formType === 'Compra'">
            <div class="form-group"><label>DescriÃ§Ã£o</label><input [(ngModel)]="formData.descricao" name="compraDescricao" required></div>
            <div class="form-group"><label>Valor</label><input type="number" [(ngModel)]="formData.valor" name="compraValor" required></div>
            <div class="form-group"><label>Data da Compra</label><input type="date" [(ngModel)]="formData.dataCompra" name="compraData" required></div>
            <div class="form-group"><label>Fornecedor</label><input [(ngModel)]="formData.fornecedor" name="compraFornecedor" required></div>
          </div>

          <!-- Campos para Comanda -->
          <div *ngIf="formType === 'Comanda'">
            <div class="form-group">
              <label>Selecionar Agendamento (Aprovado)</label>
              <select [(ngModel)]="formData.agendamentoId" name="comandaAgendamento" (change)="onAgendamentoChange()" [disabled]="formData.fechada" required>
                <option [ngValue]="null" disabled selected>Selecione...</option>
                <option *ngFor="let a of agendamentosAprovados" [value]="a.id">
                  {{ a.nomeCliente }} - {{ a.dataHora | date:'dd/MM HH:mm' }} - {{ a.procedimento }}
                </option>
              </select>
            </div>
            
            <div class="form-group" style="display: flex; gap: 10px;">
              <div style="flex: 1;">
                <label>Cliente</label>
                <input [value]="formData.clienteNome" disabled style="background: #eee;">
              </div>
              <div style="flex: 1;">
                <label>Data</label>
                <input [value]="formData.data | date:'dd/MM/yyyy HH:mm'" disabled style="background: #eee;">
              </div>
            </div>

            <hr style="margin: 1rem 0; border: 0; border-top: 1px solid #eee;">
            <h4>Itens da Comanda</h4>
            
            <!-- Adicionar Item -->
            <div *ngIf="!formData.fechada" style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 1rem; background: #f9f9f9; padding: 10px; border-radius: 4px;">
              <div style="flex: 2;">
                <label>Tipo</label>
                <select [(ngModel)]="itemParaAdicionar.tipo" name="addTipo">
                  <option value="PRODUTO">Produto</option>
                  <option value="PROCEDIMENTO">Procedimento</option>
                </select>
              </div>
              <div style="flex: 4;">
                <label>Item</label>
                <select [(ngModel)]="itemParaAdicionar.id" name="addItem">
                  <option *ngFor="let i of (itemParaAdicionar.tipo === 'PRODUTO' ? produtos : procedimentos)" [value]="i.id">
                    {{ i.nome }} - R$ {{ (itemParaAdicionar.tipo === 'PRODUTO' ? i.preco : i.valor) }}
                  </option>
                </select>
              </div>
              <div style="flex: 1;">
                <label>Qtd</label>
                <input type="number" [(ngModel)]="itemParaAdicionar.quantidade" name="addQtd" min="1">
              </div>
              <button type="button" class="btn-primary" (click)="adicionarItemComanda()" style="padding: 0.75rem;">+</button>
            </div>

            <!-- Lista de Itens -->
            <table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;">
              <tr style="background: #eee; text-align: left;"><th style="padding: 5px;">Item</th><th>Qtd</th><th>Valor</th><th>Total</th><th></th></tr>
              <tr *ngFor="let item of itensComanda; let i = index">
                <td style="padding: 5px; border-bottom: 1px solid #ddd;">{{ item.nome }}</td>
                <td style="border-bottom: 1px solid #ddd;">{{ item.quantidade }}</td>
                <td style="border-bottom: 1px solid #ddd;">R$ {{ item.valorUnitario }}</td>
                <td style="border-bottom: 1px solid #ddd;">R$ {{ item.total }}</td>
                <td style="border-bottom: 1px solid #ddd;"><button *ngIf="!formData.fechada" type="button" (click)="removerItemComanda(i)" style="color: red; border: none; background: none; cursor: pointer;">x</button></td>
              </tr>
            </table>

            <div style="text-align: right; font-size: 1.2rem; font-weight: bold; color: #2c3e50;">
              Total: R$ {{ formData.valorTotal | number:'1.2-2' }}
            </div>

            <div class="form-group" style="margin-top: 1rem;">
              <label>Forma de Pagamento</label>
              <select [(ngModel)]="formData.formaPagamento" name="formaPagamento" [disabled]="formData.fechada">
                <option [ngValue]="null" disabled selected>Selecione...</option>
                <option *ngFor="let fp of formasPagamento" [value]="fp">{{ fp }}</option>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-secondary" (click)="fecharFormulario()">Cancelar</button>
            <!-- BotÃ£o de Fechar Comanda (Aparece se nÃ£o estiver fechada) -->
            <button type="button" class="btn-warning" (click)="fecharComanda()" *ngIf="formType === 'Comanda' && !formData.fechada">Fechar Comanda</button>
            <button type="submit" class="btn-primary" *ngIf="!formData.fechada">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>